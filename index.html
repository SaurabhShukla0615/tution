<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tuition Fee Manager</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280;
    --primary:#3b82f6; --primary-600:#2563eb; --danger:#ef4444; --warn:#f59e0b; --ok:#16a34a;
    --ring: rgba(59,130,246,.22); --shadow: 0 10px 30px rgba(16,24,40,.06);
    --radius: 12px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{background:var(--primary);color:#fff;padding:16px 20px;position:sticky;top:0;z-index:5}
  header h1{margin:0;font-size:18px}
  .container{max-width:1100px;margin:18px auto;padding:0 14px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
  .field{min-width:160px;flex:1}
  label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
  input,select,button{
    font:inherit;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#fff;outline:none
  }
  input:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--ring)}
  .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.primary:hover{background:var(--primary-600)}
  .btn.light{background:#eef2ff;color:#334155}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.warn{background:var(--warn);color:#111827}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
  .pill.paid{background:#dcfce7;color:#166534}
  .pill.unpaid{background:#fee2e2;color:#991b1b}

  /* Desktop table */
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:740px}
  th,td{padding:10px;border-bottom:1px solid #eef0f3;text-align:left;vertical-align:middle}
  thead th{font-size:12px;letter-spacing:.04em;text-transform:uppercase;color:#6b7280}

  /* Mobile: transform table rows into cards with labels */
  @media (max-width: 720px){
    table.responsive{border:0}
    table.responsive thead{display:none}
    table.responsive, table.responsive tbody, table.responsive tr, table.responsive td{display:block;width:100%}
    table.responsive tr{
      background:var(--card);border-radius:12px;box-shadow:var(--shadow);
      padding:8px 12px;margin:10px 0;border:0
    }
    table.responsive td{
      border:0;padding:8px 0;display:grid;grid-template-columns:130px 1fr;gap:10px
    }
    table.responsive td::before{
      content:attr(data-label);color:var(--muted);font-weight:600
    }
    td.actions{display:block}
    td.actions > div{display:flex;flex-wrap:wrap;gap:8px}
  }

  .banner{
    display:none; /* shown dynamically */
    border-left:6px solid var(--danger);background:#fff1f2;color:#7f1d1d;
    padding:10px 12px;border-radius:8px;line-height:1.4
  }
  .banner strong{color:#b91c1c}
</style>
</head>
<body>
<header><h1>ðŸ“š Tuition Fee Manager</h1></header>
<div class="container">

  <!-- Overdue Banner -->
  <div id="overdueBanner" class="card banner"></div>

  <!-- Add Student -->
  <div class="card">
    <h3 style="margin:4px 0 12px">Add Student</h3>
    <div class="row">
      <div class="field">
        <label for="name">Student Name</label>
        <input id="name" placeholder="e.g., Name" />
      </div>
      <div class="field">
        <label for="fee">Monthly Fee (â‚¹)</label>
        <input id="fee" type="number" min="0" step="1" placeholder="1500" />
      </div>
      <div class="field" style="max-width:180px">
        <label for="dueDay">Due Day (1â€“31)</label>
        <input id="dueDay" type="number" min="1" max="31" placeholder="10" />
      </div>
      <div class="field" style="max-width:170px">
        <label>&nbsp;</label>
        <button class="btn primary" id="addBtn">Add</button>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card">
    <div class="row">
      <div class="field">
        <label for="search">Search name</label>
        <input id="search" placeholder="Type to filterâ€¦" />
      </div>
      <div class="field" style="max-width:220px">
        <label for="monthFilter">Month</label>
        <input id="monthFilter" type="month" />
      </div>
      <div class="field" style="max-width:200px">
        <label for="statusFilter">Status</label>
        <select id="statusFilter">
          <option value="">All</option>
          <option value="Paid">Paid</option>
          <option value="Not Paid">Not Paid</option>
        </select>
      </div>
      <div class="field" style="max-width:160px">
        <label>&nbsp;</label>
        <button class="btn light" id="clearFilters">Clear</button>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Students</strong>
      <span id="count" style="color:var(--muted)">0</span>
    </div>
    <div class="table-wrap">
      <table id="table" class="responsive">
        <thead>
          <tr>
            <th>Name</th><th>Fee (â‚¹)</th><th>Month</th><th>Due Date</th><th>Status</th><th>Paid On</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ========= IndexedDB Setup ========= */
let db;
const DB_NAME="TuitionDB";
const STORE="students";
const req=indexedDB.open(DB_NAME,2);
req.onupgradeneeded=(e)=>{
  db=e.target.result;
  if(!db.objectStoreNames.contains(STORE)){
    db.createObjectStore(STORE,{keyPath:"id",autoIncrement:true});
  }
};
req.onsuccess=(e)=>{ db=e.target.result; init(); };
req.onerror=()=>alert("Failed to open database");

/* ========= Helpers ========= */
const $=(id)=>document.getElementById(id);
const pad2=(n)=>String(n).padStart(2,"0");
const ymNow=()=>{const d=new Date();return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;};
const daysInMonth=(y,m)=>new Date(y,m,0).getDate(); // m: 1..12
const dueDateFor=(ym,dueDay)=>{
  const [y,m]=ym.split("-").map(Number);
  const last=daysInMonth(y,m);
  const day=Math.min(Math.max(1,Number(dueDay||1)),last);
  return `${ym}-${pad2(day)}`;
};
const fmt=(iso)=> iso? new Date(iso).toLocaleDateString(): "â€”";

/* ========= State & UI ========= */
let cache=[]; // all students
let selectedMonth=ymNow();

$("monthFilter").value=selectedMonth;

function init(){
  ensureMonthForAll(selectedMonth).then(loadAll);
  // events
  $("addBtn").addEventListener("click",onAdd);
  $("search").addEventListener("input",refresh);
  $("statusFilter").addEventListener("change",refresh);
  $("monthFilter").addEventListener("input", async ()=>{
    selectedMonth=$("monthFilter").value || ymNow();
    await ensureMonthForAll(selectedMonth);
    await loadAll();
  });
  $("clearFilters").addEventListener("click", ()=>{
    $("search").value=""; $("statusFilter").value=""; $("monthFilter").value=ymNow();
    selectedMonth=ymNow(); refresh();
  });
}

/* ========= CRUD ========= */
function tx(store=STORE,mode="readonly"){ return db.transaction(store,mode).objectStore(store); }

async function onAdd(){
  const name=$("name").value.trim();
  const fee=Number($("fee").value);
  const dueDay=Number($("dueDay").value);
  if(!name){alert("Name is required");return;}
  if(!fee || fee<0){alert("Fee must be a positive number");return;}
  if(!dueDay || dueDay<1 || dueDay>31){alert("Enter a valid due day 1â€“31");return;}

  const payments={};
  payments[selectedMonth]={ status:"Not Paid", paidOn:"" };
  await addStudent({name,feeAmount:fee,dueDay, payments});
  $("name").value=""; $("fee").value=""; $("dueDay").value="";
  await loadAll();
}
function addStudent(obj){
  return new Promise((res,rej)=>{
    const s=tx(STORE,"readwrite").add(obj);
    s.onsuccess=()=>res(); s.onerror=(e)=>rej(e.target.error);
  });
}
function updateStudent(student){
  return new Promise((res,rej)=>{
    const s=tx(STORE,"readwrite").put(student);
    s.onsuccess=()=>res(); s.onerror=(e)=>rej(e.target.error);
  });
}
function deleteStudent(id){
  if(!confirm("Delete this student and all their records?")) return;
  const s=tx(STORE,"readwrite").delete(id);
  s.onsuccess=loadAll;
}

function loadAll(){
  return new Promise((res)=>{
    const store=tx(STORE,"readonly");
    const r=store.getAll();
    r.onsuccess=()=>{ cache=r.result||[]; refresh(); res(); };
  });
}

/* Ensure each student has the selected month record */
async function ensureMonthForAll(ym){
  const all=await new Promise((res)=>{
    const r=tx(STORE,"readonly").getAll();
    r.onsuccess=()=>res(r.result||[]);
  });
  const updates=[];
  for(const st of all){
    if(!st.payments) st.payments={};
    if(!st.payments[ym]){
      st.payments[ym]={status:"Not Paid", paidOn:""};
      updates.push(updateStudent(st));
    }
  }
  if(updates.length) await Promise.all(updates);
}

/* ========= Actions ========= */
async function togglePaid(id, ym){
  const st=cache.find(s=>s.id===id); if(!st) return;
  const curr=st.payments[ym]||{status:"Not Paid",paidOn:""};
  const newStatus = curr.status==="Paid" ? "Not Paid":"Paid";
  st.payments[ym]={ status:newStatus, paidOn: newStatus==="Paid" ? new Date().toISOString() : "" };
  await updateStudent(st);
  await loadAll();
}

/* ========= Rendering & Filters ========= */
function applyFilters(){
  const q=$("search").value.trim().toLowerCase();
  const status=$("statusFilter").value; // "", "Paid", "Not Paid"
  const rows=[];
  for(const st of cache){
    if(q && !st.name.toLowerCase().includes(q)) continue;
    const p=st.payments?.[selectedMonth];
    if(!p) continue;
    if(status && p.status!==status) continue;
    rows.push({
      id:st.id, name:st.name, feeAmount:st.feeAmount, dueDay:st.dueDay,
      ym:selectedMonth, status:p.status, paidOn:p.paidOn
    });
  }
  return rows.sort((a,b)=> a.name.localeCompare(b.name));
}

function refresh(){
  const rows=applyFilters();
  const tbody=$("tbody"); tbody.innerHTML="";
  for(const r of rows){
    const tr=document.createElement("tr");
    const dueDate=dueDateFor(r.ym,r.dueDay);
    tr.innerHTML=`
      <td data-label="Name">${r.name}</td>
      <td data-label="Fee (â‚¹)">â‚¹${r.feeAmount}</td>
      <td data-label="Month">${r.ym}</td>
      <td data-label="Due Date">${fmt(dueDate)}</td>
      <td data-label="Status"><span class="pill ${r.status==='Paid'?'paid':'unpaid'}">${r.status}</span></td>
      <td data-label="Paid On">${fmt(r.paidOn)}</td>
      <td class="actions" data-label="Actions">
        <div>
          <button class="btn ${r.status==='Paid'?'warn':'primary'}" onclick="togglePaid(${r.id}, '${r.ym}')">
            ${r.status==='Paid'?'Mark Not Paid':'Mark Paid'}
          </button>
          <button class="btn danger" onclick="deleteStudent(${r.id})">Delete</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }
  $("count").textContent = `${rows.length} record${rows.length===1?"":"s"} for ${selectedMonth}`;
  renderOverdueBanner(rows);
}

/* ========= Overdue Banner ========= */
function renderOverdueBanner(rows){
  const banner=$("overdueBanner");
  const today=new Date();
  const overdue=rows.filter(r=>{
    if(r.status==="Paid") return false;
    const due=new Date(dueDateFor(r.ym,r.dueDay));
    return today>due; // overdue
  });
  if(!overdue.length){
    banner.style.display="none"; banner.innerHTML="";
    return;
  }
  const names=overdue.map(r=>r.name);
  banner.style.display="block";
  banner.innerHTML = `
    <strong>Overdue:</strong> ${overdue.length} student${overdue.length===1?"":"s"} for <strong>${selectedMonth}</strong>.
    ${names.slice(0,5).join(", ")}${names.length>5?` +${names.length-5} more`:''}.
  `;
}

</script>
</body>
</html>
