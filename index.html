<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tuition Manager </title>
<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#6b7280;
  --primary:#2563eb; --danger:#dc2626; --ok:#16a34a; --warn:#b45309;
  --shadow: 0 12px 28px rgba(16,24,40,.07); --radius:14px;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
header{background:var(--primary);color:#fff;padding:14px 18px;position:sticky;top:0;z-index:60}
header h1{margin:0;font-size:18px}
.container{max-width:1100px;margin:16px auto;padding:0 14px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.field{min-width:160px;flex:1}
label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
input,select,button{font:inherit;border:1px solid #e6e9ee;border-radius:10px;padding:9px 12px;background:#fff;outline:none}
input:focus,select:focus{box-shadow:0 0 0 4px rgba(37,99,235,.12);border-color:var(--primary)}
.btn{border:0;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--primary);color:#fff}
.btn.primary:hover{filter:brightness(.95)}
.btn.light{background:#eef2ff;color:#334155}
.btn.danger{background:var(--danger);color:#fff}
.btn.ok{background:var(--ok);color:#fff}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}
.pill.paid{background:#dcfce7;color:#166534}
.pill.unpaid{background:#fee2e2;color:#991b1b}
.muted{color:var(--muted);font-size:13px}
.grid{display:grid;gap:12px;grid-template-columns:repeat(3,minmax(0,1fr))}
@media (max-width:960px){ .grid{grid-template-columns:repeat(2,1fr)} }
@media (max-width:640px){ .grid{grid-template-columns:1fr} }

/* student card */
.student-card{border:1px solid #eef0f3;border-radius:12px;padding:12px}
.student-top{display:flex;justify-content:space-between;gap:8px;align-items:flex-start;flex-wrap:wrap}
.name{font-weight:800}
.meta{font-size:13px;color:var(--muted)}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

/* history table */
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse;min-width:700px}
th,td{padding:10px;border-bottom:1px solid #eef0f3;text-align:left}
thead th{font-size:12px;text-transform:uppercase;color:#6b7280}
@media (max-width:720px){
  table.responsive thead{display:none}
  table.responsive,table.responsive tbody, table.responsive tr, table.responsive td{display:block;width:100%}
  table.responsive tr{background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:8px 12px;margin:10px 0}
  table.responsive td{border:0;padding:8px 0;display:grid;grid-template-columns:130px 1fr;gap:10px}
  table.responsive td::before{content:attr(data-label);color:var(--muted);font-weight:700}
}

/* overdue banner */
.overdue-banner{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:#fff1f2;border-left:6px solid var(--danger);color:#7f1d1d}
.overdue-list{display:flex;gap:8px;flex-wrap:wrap}
.overdue-btn{background:transparent;border:0;color:var(--danger);cursor:pointer;font-weight:700;text-decoration:underline;padding:6px;border-radius:8px}
.overdue-none{color:#065f46;background:#ecfdf5;padding:8px;border-radius:8px;border-left:4px solid #10b981}

/* highlight effect when clicked from banner */
.highlight{
  box-shadow:0 0 0 4px rgba(99,102,241,.12), 0 6px 22px rgba(16,24,40,.12) !important;
  transform: translateY(-3px);
  transition:transform .18s ease, box-shadow .18s ease;
}

/* small helpers */
.small{font-size:13px}
</style>
</head>
<body>
<header><h1>üìö Tuition Manager </h1></header>
<div class="container">

  <!-- OVERDUE BANNER (top of list) -->
  <div id="overdueArea" class="card" style="display:none">
    <div id="overdueInner"></div>
  </div>

  <!-- Add -->
  <div class="card" id="addSection">
    <h3 style="margin:4px 0 12px">Add Student</h3>
    <div class="row">
      <div class="field">
        <label for="name">Student Name</label>
        <input id="name" placeholder="e.g., Name" />
      </div>
      <div class="field" style="max-width:220px">
        <label for="fee">Monthly Fee (‚Çπ)</label>
        <input id="fee" type="number" min="0" step="1" placeholder="1500" />
      </div>
      <div class="field" style="max-width:220px">
        <label for="joinDate">Join Date</label>
        <input id="joinDate" type="date" />
      </div>
      <div class="field" style="max-width:160px">
        <label>&nbsp;</label>
        <button class="btn primary" id="addBtn">Add</button>
      </div>
    </div>
  </div>

  <!-- Student List -->
  <div class="card" id="listSection">
    <div class="row" style="justify-content:space-between">
      <strong>Students</strong>
      <div style="display:flex;gap:10px;align-items:center">
        <div style="min-width:220px">
          <label for="search">Search</label>
          <input id="search" placeholder="Search by name‚Ä¶" />
        </div>
        <div class="small muted" id="count">0</div>
      </div>
    </div>
    <div id="studentGrid" class="grid" style="margin-top:12px"></div>
  </div>

  <!-- History -->
  <div class="card" id="historySection" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <div>
        <button class="btn light" id="backBtn">‚Üê Back</button>
        <strong id="histTitle" style="margin-left:10px"></strong>
      </div>
      <div class="muted" id="histMeta"></div>
    </div>
    <div class="table-wrap">
      <table id="histTable" class="responsive">
        <thead><tr><th>Month</th><th>Service Period</th><th>Due Date</th><th>Status</th><th>Paid On</th><th>Action</th></tr></thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* ========= IndexedDB setup ========= */
let db;
const DB="TuitionDB_Postpaid";
const STORE="students";
const req=indexedDB.open(DB,1);
req.onupgradeneeded=(e)=>{ db=e.target.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE,{keyPath:"id",autoIncrement:true}); };
req.onsuccess=(e)=>{ db=e.target.result; init(); };
req.onerror=()=>alert("IndexedDB error");

/* ========= utils ========= */
const $=(id)=>document.getElementById(id);
const pad=(n)=>String(n).padStart(2,"0");
function ym(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}`; }
function fromYM(ymStr){ const [y,m]=ymStr.split("-").map(Number); return new Date(y,m-1,1); }
function addMonths(d,n){ return new Date(d.getFullYear(), d.getMonth()+n, 1); }
function monthLabel(d){ return d.toLocaleString(undefined,{month:"long", year:"numeric"}); }
function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }
function clampDay(y,m,day){ return Math.min(Math.max(1,day), daysInMonth(y,m)); }
function dateISO(y,m,day){ return `${y}-${pad(m)}-${pad(day)}`; }
function fmtDate(iso){ if(!iso) return "‚Äî"; const d=new Date(iso); return isNaN(d)?"‚Äî":d.toLocaleDateString(); }

/* last completed month (service months up to last month) */
function lastMonthYM(){ const now=new Date(); const lm=new Date(now.getFullYear(), now.getMonth()-1, 1); return ym(lm); }

/* build visible service months array (start = max(joinMonth, lastMonth-11), end = lastMonth) */
function serviceWindowFor(joinISO){
  const join = new Date(joinISO);
  const joinStart = new Date(join.getFullYear(), join.getMonth(), 1);
  const lm = fromYM(lastMonthYM());
  const earliest = addMonths(lm, -11);
  const start = joinStart > earliest ? joinStart : earliest;
  const months=[];
  for(let d=new Date(start); d<=lm; d=addMonths(d,1)) months.push(ym(d));
  return months;
}

/* due date for a service month (postpaid): next month same day-of-month as join (clamped) */
function dueDateFor(serviceYM, joinISO){
  const join = new Date(joinISO);
  const joinDay = join.getDate();
  const service = fromYM(serviceYM);
  const next = addMonths(service,1); // due in next month
  const y = next.getFullYear(), m = next.getMonth()+1;
  const day = clampDay(y,m,joinDay);
  return dateISO(y,m,day);
}

/* ========= DB helpers ========= */
function store(mode="readonly"){ return db.transaction(STORE,mode).objectStore(STORE); }
function getAllStudents(){ return new Promise(res=>{ const r=store().getAll(); r.onsuccess=()=>res(r.result||[]); }); }
function addStudent(obj){ return new Promise((res,rej)=>{ const r=store("readwrite").add(obj); r.onsuccess=()=>res(); r.onerror=(e)=>rej(e.target.error); }); }
function updateStudent(obj){ return new Promise((res,rej)=>{ const r=store("readwrite").put(obj); r.onsuccess=()=>res(); r.onerror=(e)=>rej(e.target.error); }); }
function deleteStudentDB(id){ const r=store("readwrite").delete(id); r.onsuccess=()=>loadAll(); }

/* ========= app state ========= */
let cache=[]; // students
let currentStudent=null;

/* ========= init & bindings ========= */
function init(){
  $("addBtn").addEventListener("click", onAdd);
  $("search").addEventListener("input", renderList);
  $("backBtn").addEventListener("click", ()=>{ showList(); });
  loadAll();
}

/* ========= core logic ========= */
async function onAdd(){
  const name = $("name").value.trim();
  const fee = Number($("fee").value);
  const joinDate = $("joinDate").value;
  if(!name){ alert("Enter name"); return; }
  if(!fee || fee<0){ alert("Enter valid fee"); return; }
  if(!joinDate){ alert("Enter join date"); return; }

  const student = { name, feeAmount:fee, joinDate, payments:{} };
  // pre-fill window months with Not Paid
  for(const m of serviceWindowFor(joinDate)) student.payments[m] = { status:"Not Paid", paidOn:"" };
  await addStudent(student);
  $("name").value=""; $("fee").value=""; $("joinDate").value="";
  await loadAll();
}

async function loadAll(){
  cache = await getAllStudents();
  // normalize payments: ensure window months exist and prune older months
  const updates=[];
  for(const s of cache){
    s.payments = s.payments || {};
    const window = serviceWindowFor(s.joinDate);
    // remove keys not in window
    for(const k of Object.keys(s.payments || {})){ if(!window.includes(k)) delete s.payments[k]; }
    // add missing months
    for(const m of window){ if(!s.payments[m]) s.payments[m] = {status:"Not Paid", paidOn:""}; }
    updates.push(updateStudent(s));
  }
  if(updates.length) await Promise.all(updates);
  renderList();
}

/* compute overdue list: unpaid & dueDate < today for any visible service month */
function computeOverdues(){
  const lm = lastMonthYM();
  const today = new Date();
  const res = [];
  for(const s of cache){
    // check any visible month where status Not Paid and due < today
    const window = serviceWindowFor(s.joinDate);
    for(const m of window){
      const entry = s.payments?.[m];
      if(!entry) continue;
      if(entry.status === "Paid") continue;
      const dueISO = dueDateFor(m, s.joinDate);
      if(new Date(dueISO) < today){ res.push({id:s.id, name:s.name}); break; }
    }
  }
  return res;
}

/* toggle paid state for a student & month */
async function togglePaid(stud, ymStr){
  const ent = stud.payments[ymStr] || {status:"Not Paid", paidOn:""};
  const newStatus = ent.status === "Paid" ? "Not Paid" : "Paid";
  stud.payments[ymStr] = { status:newStatus, paidOn: newStatus === "Paid" ? new Date().toISOString() : "" };
  await updateStudent(stud);
  // Update cache and re-render only the current history view
  if (currentStudent && currentStudent.id === stud.id) {
    Object.assign(currentStudent, stud);
    renderHistory(currentStudent);
    renderOverdueBanner();
  } else {
    await loadAll();
  }
}

/* ========= rendering ========= */

function renderOverdueBanner(){
  const list = computeOverdues();
  const area = $("overdueArea");
  const inner = $("overdueInner");
  if(!list.length){
    area.style.display = "none"; inner.innerHTML = ""; return;
  }
  area.style.display = "block";
  // create content with clickable names
  inner.innerHTML = `
    <div class="overdue-banner">
      <div style="font-weight:800">Overdue Fees</div>
      <div class="overdue-list" id="overdueNames"></div>
    </div>`;
  const namesWrap = $("overdueNames");
  namesWrap.innerHTML = "";
  for(const item of list){
    const btn = document.createElement("button");
    btn.className="overdue-btn";
    btn.textContent = item.name;
    btn.onclick = ()=>{ goToStudent(item.id); };
    namesWrap.appendChild(btn);
  }
}

function renderList(){
  renderOverdueBanner();
  const q = $("search").value.trim().toLowerCase();
  const grid = $("studentGrid");
  grid.innerHTML = "";
  const filtered = cache.filter(s => s.name.toLowerCase().includes(q)).sort((a,b)=>a.name.localeCompare(b.name));
  $("count").textContent = `${filtered.length} student${filtered.length===1?"":"s"}`;
  for(const s of filtered){
    const out = outstandingCount(s);
    const joinText = new Date(s.joinDate).toLocaleDateString();
    const card = document.createElement("div");
    card.className = "student-card";
    card.id = `student-card-${s.id}`;
    card.innerHTML = `
      <div class="student-top">
        <div>
          <div class="name">${s.name}</div>
          <div class="meta">Joined: ${joinText} ‚Ä¢ Fee: ‚Çπ${s.feeAmount}</div>
        </div>
        <div>
          <span class="pill ${out? 'unpaid':'paid'}">${out} due</span>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" data-action="view" data-id="${s.id}">View History</button>
        <button class="btn danger" data-action="del" data-id="${s.id}">Delete</button>
      </div>
    `;
    grid.appendChild(card);
  }

  grid.onclick = (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const id = Number(btn.getAttribute("data-id"));
    const act = btn.getAttribute("data-action");
    const st = cache.find(x=>x.id===id);
    if(!st) return;
    if(act==="view") showHistory(st);
    if(act==="del"){
      if(confirm(`Delete ${st.name} and all recorded months?`)) deleteStudentDB(st.id);
    }
  };
}

/* outstanding count = unpaid months in visible window */
function outstandingCount(s){
  const months = serviceWindowFor(s.joinDate);
  let c=0;
  for(const m of months){ if((s.payments?.[m]?.status||"Not Paid")!=="Paid") c++; }
  return c;
}

/* scroll to student card and highlight; if not on list, show list first */
function goToStudent(id){
  showList();
  setTimeout(()=>{ // allow UI to render
    const el = document.getElementById(`student-card-${id}`);
    if(!el) return;
    el.scrollIntoView({behavior:"smooth", block:"center"});
    el.classList.add("highlight");
    setTimeout(()=>el.classList.remove("highlight"), 1600);
  }, 120);
}

/* -------- history view -------- */
function showHistory(st){
  currentStudent = st;
  $("listSection").style.display = "none";
  $("addSection").style.display = "none";
  $("historySection").style.display = "block";
  renderHistory(st);
}
function showList(){
  currentStudent = null;
  $("historySection").style.display = "none";
  $("addSection").style.display = "";
  $("listSection").style.display = "";
  renderList();
}

function renderHistory(st){
  $("histTitle").textContent = st.name;
  $("histMeta").textContent = `Joined: ${new Date(st.joinDate).toLocaleDateString()} ‚Ä¢ Fee: ‚Çπ${st.feeAmount}`;
  const months = serviceWindowFor(st.joinDate);
  const tbody = $("histBody"); tbody.innerHTML = "";
  for(const m of months){
    const entry = st.payments?.[m] || {status:"Not Paid", paidOn:""};
    const serviceStart = fromYM(m);
    const dueISO = dueDateFor(m, st.joinDate);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td data-label="Month">${monthLabel(serviceStart)}</td>
      <td data-label="Service Period">${monthLabel(serviceStart)}</td>
      <td data-label="Due Date">${fmtDate(dueISO)}</td>
      <td data-label="Status"><span class="pill ${entry.status==='Paid'?'paid':'unpaid'}">${entry.status}</span></td>
      <td data-label="Paid On">${fmtDate(entry.paidOn)}</td>
      <td data-label="Action">
        <button class="btn ${entry.status==='Paid'?'light':'ok'}" data-action="toggle" data-ym="${m}" data-id="${st.id}">
          ${entry.status==='Paid'?'Mark Not Paid':'Mark Paid'}
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  }
  // action handler
  $("histTable").onclick = async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const action = btn.getAttribute("data-action");
    if(action==="toggle"){
      const id = Number(btn.getAttribute("data-id"));
      const ymStr = btn.getAttribute("data-ym");
      const stud = cache.find(x=>x.id===id);
      if(stud) await togglePaid(stud, ymStr);
    }
  };
}

/* ========= start ========= */
</script>
<script>
/* loadAll invoked after db open; attach missing helper functions that rely on defs below */
async function loadAll(){ /* placeholder; replaced below */ }
(async function attachLoadAll(){
  // redefine loadAll in the outer scope now that functions are defined
  loadAll = async function(){
    cache = await getAllStudents();
    const updates = [];
    for(const st of cache){
      st.payments = st.payments || {};
      const window = serviceWindowFor(st.joinDate);
      // prune old keys, ensure window keys exist
      for(const k of Object.keys(st.payments||{})){ if(!window.includes(k)) delete st.payments[k]; }
      for(const m of window){ if(!st.payments[m]) st.payments[m] = {status:"Not Paid", paidOn:""}; }
      updates.push(updateStudent(st));
    }
    if(updates.length) await Promise.all(updates);
    renderList();
  };
})();
</script>
</body>
</html>
